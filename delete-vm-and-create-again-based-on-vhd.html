<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="JustCloud Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="JustCloud Blog Atom Feed"><title data-react-helmet="true">Delete VM and create again based on .vhd | JustCloud Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.justcloud.pl/delete-vm-and-create-again-based-on-vhd"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="JustCloud the best quality of knowledge" content="azure, aws, gcp, devops, automation, azure devops, blog, microsoft, linux, azure policy, cloud transformation, digital transformation, governance, security, pipelines, github"><meta data-react-helmet="true" property="og:title" content="Delete VM and create again based on .vhd | JustCloud Blog"><meta data-react-helmet="true" name="description" content="Rekreowanie maszyny z istniejcego dysku mo偶e by konieczne kiedy mamy migracjlub problemy z maszyn. Ten artyku opisuje jak sprawnie przej przed ten proces."><meta data-react-helmet="true" property="og:description" content="Rekreowanie maszyny z istniejcego dysku mo偶e by konieczne kiedy mamy migracjlub problemy z maszyn. Ten artyku opisuje jak sprawnie przej przed ten proces."><meta data-react-helmet="true" name="keywords" content="powershell,azure,microsoft azure,storage account,vhd,migracja,migration,network,sie,blog"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2017-09-30T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/RogalaPiotr"><meta data-react-helmet="true" property="article:tag" content="azure,blob,devops,powershell,storage,vm,migracja"><link data-react-helmet="true" rel="icon" href="https://raw.githubusercontent.com/RogalaPiotr/JustCloudWeb/gh-pages/assets/images/favicon-new-1.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.justcloud.pl/delete-vm-and-create-again-based-on-vhd"><link data-react-helmet="true" rel="alternate" href="https://blog.justcloud.pl/delete-vm-and-create-again-based-on-vhd" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.justcloud.pl/delete-vm-and-create-again-based-on-vhd" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.753318a1.css">
<link rel="preload" href="/assets/js/runtime~main.67dd5cc8.js" as="script">
<link rel="preload" href="/assets/js/main.7a5b0790.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="JustCloud.pl" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="JustCloud.pl" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">JustCloud.pl</b></a></div><div class="navbar__items navbar__items--right"><a href="https://justcloud.pl/index.html#form5-28" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Contact<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/RogalaPiotr/justcloudpublic" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF"></span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF"></span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/how to deploy azure pipelines agent">Jak wdro偶y Azure Pipelines agenta? (How to deploy Azure Pipelines agent?)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/welcome">Nowa odsona</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/tags-in-azure">Przyspieszenie pracy nad tagowaniem zasob贸w za pomoc PowerShell - Tag raport Microsoft Azure</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/wyslanie-zadania-api-z-powershell-do-azure-devops">Wysanie 偶dania API z PowerShell do Azure DevOps</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/iac-control-via-powershell-module-for-arm-templates">IaC control via PowerShell module for ARM templates</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/skad-uczyc-sie-o-microsoft-azure">Skd uczy si o Microsoft Azure?</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/auto-deployment-vm-with-vsts-agent-for-pool">Auto deployment VM with VSTS agent for pool</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/google-cloud-platform-deployment-vm-z-ubuntu">Google Cloud Platform deployment VM z Ubuntu</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/delete-vm-and-create-again-based-on-vhd">Delete VM and create again based on .vhd</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/deployment-maszyny-z-funkcja-auto-shutdown-za-pomoca-szablonu-arm">Deployment maszyny z funkcj Auto-Shutdown  za pomoc szablonu arm</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/profil-logowania-do-azure">Profil logowania do Azure</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/visual-studio-code-i-git-zamiast-powershell-ise">Visual Studio Code i Git zamiast PowerShell ISE - UPDATED</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/grupa-specjalistow-cloudpoland-na-slacku">Grupa specjalist贸w CloudPoland na Slack&#x27;u</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/tworzenie-szablonu-arm-visual-studio-2017">Tworzenie szablonu ARM - Visual Studio 2017</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/azure-resource-manager-json-automation">Azure Resource Manager - JSON Automation</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Delete VM and create again based on .vhd</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2017-09-30T00:00:00.000Z" itemprop="datePublished">September 30, 2017</time> 路 <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/RogalaPiotr" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://avatars.githubusercontent.com/u/31566956?v=4" alt="Piotr Rogala"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/RogalaPiotr" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Piotr Rogala</span></a></div><small class="avatar__subtitle" itemprop="description">MVP Azure &amp; owner JustCloud.pl</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>W tej czci tytu jest angielski,poniewa偶 nie stosuje spolszcze dla technicznego jzyka. Ten post jest spowodowany tym co Microsoft niestety przesta wspiera w Azure a mianowicie breaklease dla blob贸w podpitych do wirtualnej maszyny. Byo mi to potrzebne do jednego zadania, dlatego byem zmuszony zrobi co innego. Mianowicie potrzebne mi byo usunicie maszyny i stworzenie jej bazujc na istniejcych vhd&#x27;kach w innym kontenerze dodatkowo moje zao偶enie wymagao powershell&#x27;a. W skr贸cie odtworzenie maszyny z jakiego stanu, kt贸ry jest przechowywany jako kopia dysk贸w wirtualnej maszyny. Myl, 偶e s osoby, kt贸rym si to przyda.</p><p>Kr贸tki opis:</p><ol><li>Podajemy nazw maszyny lub list maszyn z naszej subskrypcji.</li><li>Na podstawie nazwy maszyny znajdujemy resource groupe.</li><li>Wyczamy maszyn.</li><li>Na podstawie RG i nazwy VM sprawdzamy jakie dyski s podpite do maszyny.</li><li>Znajdujemy sobie context dla dysk贸w.</li><li>Majc wszystkie dane przechodzimy do usuwania maszyny.</li><li>Usuwany obecny vhd z OS.</li><li>Kopiujemy w jego miejsce wczeniej skopiowany vhd z kontenera &quot;images&quot;.</li><li>Przeprowadzamy dalej t sam operacje dla wszystkich podpitych dysk贸w data.</li><li>Na podstawie wszystkich zebranych wczeniej danych tworzymy wirtualn maszyn.</li></ol><p>Puenta jest taka. Jeli oka偶e si, 偶e kt贸rego razu Microsoft Support powie wam, 偶e trzeba usun maszyn i stworzy j ponownie dziki temu skryptowi mo偶ecie to zrobi zaledwie w 5 minut i potwierdzi, czy to pomogo czy diagnoza Supportu bya niewaciwa. Zdarza si, 偶e MS sugeruje usunicie maszyny i stworzenie jej ponownie i majc np. 5 maszyn wiecie, 偶e nie jest to zabawa na 5 minut. Ale teraz wykorzystujc ten skrypt mo偶ecie to zrobi. Wczeniejszym etapem bdzie poprawienie skryptu, aby nie usuwa dysk贸w vhd tylko u偶y obecnych. Natomiast jeli chcecie zrobi sobie kopie bezpieczestwa dysk贸w vhd to bdzie nale偶e przeprowadzi procedur wyczenia maszyn skopiowania vhd&#x27;k贸w np. do kontenera &quot;images&quot; i puci poni偶szy skrypt.</p><p>Skrpyt w bardziej czytelnej formie na github:<a href="https://github.com/RogalaPiotr/JustCloudPublic/tree/master/recreate-vm-from-vhd" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/tree/master/recreate-vm-from-vhd</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$vms = @(&quot;SimpleWindowsVM&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sourcecontainerimage = &quot;images&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function recreatevms {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach ($vm in $vms) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;VM name: &quot;$vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmrg = Get-AzureRmResource | Where-Object {$_.Name -like $vm}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;VM Resource Group: &quot;$vmrg.ResourceGroupName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmsize = (Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -VMName $vm).HardwareProfile.VmSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;VM size: &quot;$vmsize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $nicvm = Get-AzureRmNetworkInterface -ResourceGroupName $vmrg.ResourceGroupName | Where-Object {$_.VirtualMachine.Id -like &quot;*$vm*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;VM NIC name: &quot;$nicvm.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmstatus = Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm -Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;VM status is: &quot;$vmstatus.Statuses.DisplayStatus[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if($vmstatus.Statuses.DisplayStatus -like &quot;*running*&quot;){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Write-Host &quot;VM stopping: &quot;$vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $tmp = Stop-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmdiskos = ((Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm).StorageProfile).OsDisk 3&gt; $null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmdisksdata = ((Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm).StorageProfile).DataDisks 3&gt; $null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;Get VM disk os: &quot;$vmdiskos.Name </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;Get VM disk data: &quot;$vmdisksdata.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;Get VM disk data count: &quot;$vmdisksdata.Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storagediskosname = ($vmdiskos.Vhd.Uri.Split(&quot;/&quot;)[2]).Replace(&quot;.blob.core.windows.net&quot;,&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $containerdiskos = ($vmdiskos.Vhd.Uri.Split(&quot;/&quot;)[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmdiskosname = ($vmdiskos.Vhd.Uri.Split(&quot;/&quot;)[4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storageaccountos = Get-AzureRmResource | Where-Object {$_.Name -like &quot;$storagediskosname&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storageaccountkeyos = (Get-AzureRmStorageAccountKey -Name $storageaccountos.Name -ResourceGroupName $storageaccountos.ResourceGroupName).Value[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storagecontext = New-AzureStorageContext -StorageAccountName $storageaccountos.Name -StorageAccountKey $storageaccountkeyos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $container = Get-AzureStorageContainer -Name $containerdiskos -context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $containerdiskosimage = $vmdiskos.Vhd.Uri -replace(&quot;vhds&quot;,$sourcecontainerimage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Remove-AzureRmVM -Name $vm -ResourceGroupName $vmrg.ResourceGroupName -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;Removing VM: &quot;$vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Remove-AzureStorageBlob -Blob $vmdiskosname -Container vhds -Context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;Removing VM os disk uri: &quot;$vmdiskos.Vhd.Uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tmp = Start-AzureStorageBlobCopy -srcUri $containerdiskosimage -SrcContext $storagecontext -DestContainer $containerdiskos -DestBlob $vmdiskosname -DestContext $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host  &quot;Copying new os disk uri: &quot;$containerdiskosimage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (![string]::IsNullOrEmpty($vmdisksdata)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            foreach ($vmdiskdata in $vmdisksdata){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storagediskdataname = ($vmdiskdata.Vhd.Uri.Split(&quot;/&quot;)[2]).Replace(&quot;.blob.core.windows.net&quot;,&quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $containerdiskdata = ($vmdiskdata.Vhd.Uri.Split(&quot;/&quot;)[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $vmdiskdataname = ($vmdiskdata.Vhd.Uri.Split(&quot;/&quot;)[4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storageaccountdata = Get-AzureRmResource | Where-Object {$_.Name -like &quot;$storagediskdataname&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storageaccountkeydata = (Get-AzureRmStorageAccountKey -Name $storageaccountdata.Name -ResourceGroupName $storageaccountdata.ResourceGroupName).Value[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storagecontext = New-AzureStorageContext -StorageAccountName $storageaccountdata.Name -StorageAccountKey $storageaccountkeydata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $container = Get-AzureStorageContainer -Name $containerdiskdata -context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $containerdiskdataimage = $vmdiskdata.Vhd.Uri -replace(&quot;vhds&quot;,$sourcecontainerimage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Remove-AzureStorageBlob -Blob $vmdiskdataname -Container vhds -Context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Write-Host &quot;Removing VM data disk uri: &quot;$vmdiskdata.Vhd.Uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $tmp = Start-AzureStorageBlobCopy -srcUri $containerdiskdataimage -SrcContext $storagecontext -DestContainer $containerdiskdata -DestBlob $vmdiskdataname -DestContext $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Write-Host  &quot;Copying new os disk uri: &quot;$containerdiskdataimage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host &quot;Creating VM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = New-AzureRmVMConfig -VMName $vm -VMSize $vmsize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = Set-AzureRmVMOSDisk -VM $vmConfig -Name $vmdiskos.Name -VhdUri $vmdiskos.Vhd.Uri -CreateOption Attach -Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($vmdisksdata.count -ge 0){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $i = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            foreach ($vmdiskdatavm in $vmdisksdata){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $vmConfig = Add-AzureRmVMDataDisk -VM $vmConfig -VhdUri $vmdiskdatavm.Vhd.Uri -CreateOption Attach -Lun $i -Name $vmdiskdatavm.Name -Caching ReadWrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $i++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = Add-AzureRmVMNetworkInterface -VM $vmConfig -Id $nicvm.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = Set-AzureRmVMBootDiagnostics -VM $vmConfig -Disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vm = New-AzureRmVM -VM $vmConfig -Location $vmrg.Location -ResourceGroupName $vmrg.ResourceGroupName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############################################################################################################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Recreate VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############################################################################################################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recreatevms</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure">azure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/blob">blob</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/devops">devops</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/powershell">powershell</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/storage">storage</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vm">vm</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/migracja">migracja</a></li></ul></div></footer></article><div id="disqus_thread"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/google-cloud-platform-deployment-vm-z-ubuntu"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Google Cloud Platform deployment VM z Ubuntu</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/deployment-maszyny-z-funkcja-auto-shutdown-za-pomoca-szablonu-arm"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Deployment maszyny z funkcj Auto-Shutdown  za pomoc szablonu arm</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">JustCloud links</div><ul class="footer__items"><li class="footer__item"><a href="https://justcloud.pl" target="_blank" rel="noopener noreferrer" class="footer__link-item">Web: JustCloud.pl</a></li><li class="footer__item"><a href="https://web.justcloud.pl/index.html#form5-28" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact</a></li><li class="footer__item"><a href="https://github.com/RogalaPiotr/justcloudpublic" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li><li class="footer__item"><a href="https://dev.azure.com/justcloudpublic" target="_blank" rel="noopener noreferrer" class="footer__link-item">Azure DevOps</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://azurepoland.pl/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Azure Poland<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.meetup.com/Microsoft-Azure-Users-Group-Poland/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Meetup MAUGP<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/">Blog</a></li><li class="footer__item"><a href="https://www.subscribepage.com/wroclaw-newsletter-workshops" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Newsletter Workshops<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/RogalaPiotr/Presentations" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Prezentacje<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Stay in touch!</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/RogalaPiotr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://pl.linkedin.com/in/rogalapiotr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://piotr-rogala.medium.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.justcloud.pl/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS Feed<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 漏 2022 JustCloud.pl, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.67dd5cc8.js"></script>
<script src="/assets/js/main.7a5b0790.js"></script>
</body>
</html>