<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://blog.justcloud.pl/</id>
    <title>JustCloud Blog Blog</title>
    <updated>2022-01-22T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://blog.justcloud.pl/"/>
    <subtitle>JustCloud Blog Blog</subtitle>
    <icon>https://blog.justcloud.pl/https://raw.githubusercontent.com/RogalaPiotr/JustCloudWeb/gh-pages/assets/images/favicon-new-1.ico</icon>
    <entry>
        <title type="html"><![CDATA[Nowa odsÅ‚ona]]></title>
        <id>welcome</id>
        <link href="https://blog.justcloud.pl/welcome"/>
        <updated>2022-01-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Nowy rok 2022 bÄ™dzie czasem zmian dla moich aktywnoÅ›ci w Internecie. Rozpoczynam od zmian zwiÄ…zanych z blogiem i aktywnoÅ›ciami IT w community.]]></summary>
        <content type="html"><![CDATA[<p>Witam na nowej stronie gdziÄ™ bÄ™dÄ™ wrzucaÅ‚ nowe posty zwiÄ…zane z Microsoft Azure oraz Cloudâ˜ï¸. Nowy rok 2022 mam nadziejÄ™ Å¼e przyniesie wiele pozytywnych zmian. Dlatego zapraszam do kontaktu i odwiedzin mojej strony.</p><p>Nowe linki i maÅ‚e zmiany:</p><ul><li><a href="https://web.justcloud.pl" target="_blank" rel="noopener noreferrer">JustCloud â˜ï¸ Page</a></li><li><a href="https://blog.justcloud.pl" target="_blank" rel="noopener noreferrer">JustCloud â˜ï¸ Blog</a></li></ul><p>W najbliÅ¼szym czasie&nbsp;ogarnÄ™&nbsp;rÃ³wnieÅ¼ uzupeÅ‚nienie bloga o stare posty ğŸ™ƒ.</p><p>DziÄ™ki i do zobaczenia!</p><p><img src="https://images.unsplash.com/photo-1472898965229-f9b06b9c9bbe?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2070&amp;q=80" alt="welcome"></p>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="welcome" term="welcome"/>
        <category label="first post" term="first post"/>
        <category label="blog" term="blog"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Przyspieszenie pracy nad tagowaniem zasobÃ³w za pomocÄ… PowerShell - Tag raport Microsoft Azure]]></title>
        <id>tags-in-azure</id>
        <link href="https://blog.justcloud.pl/tags-in-azure"/>
        <updated>2021-06-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Zastanawiasz siÄ™ jak tagowaÄ‡ zasoby w Azure? W tym artykule dokÅ‚adnie opisuje jak to zrobiÄ‡ dla maÅ‚ych i duÅ¼ych Å›rodowisk w Auzre.]]></summary>
        <content type="html"><![CDATA[<p>KiedyÅ› przygotowaÅ‚em ten skrypt Å¼eby szybko mÃ³c otagowaÄ‡ wiele zasobÃ³w wdroÅ¼onych na platformie Microsoft Azure. Jest wiele moÅ¼liwoÅ›ci jak to zrobiÄ‡ szybko, prosto, ale staraÅ‚em siÄ™ zrobiÄ‡ uniwersalne rozwiÄ…zanie bÄ™dÄ…ce Å‚atwe oraz bezpieczne w uÅ¼yciu. Dlatego postanowiÅ‚em zrobiÄ‡ jeden skrypt, ktÃ³ry generuje nam wszystkie zasoby do pliku CSV. A drugi skrypt na podstawie pliku CSV bÄ™dzie pobieraÅ‚ z niego dane zasobÃ³w i nadpisywaÅ‚ je na platformie.</p><p>Skrypty sÄ… dostÄ™pne na GitHub:</p><ul><li><a href="https://github.com/RogalaPiotr/JustCloudPublic/tree/master/azure-tags-report" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/tree/master/azure-tags-report</a></li></ul><p>Opis skryptÃ³w:</p><ul><li>GetAllTags.ps1- generuje dwa pliki CSV. Jeden plik dla Resource Group, a drugi plik dla Resources. Jest to istotne poniewaÅ¼ mamy oddzielone grupy i moÅ¼emy inaczej tagowaÄ‡ grupy od zasobÃ³w bez szukania typÃ³w zasobÃ³w.</li><li>SetTagsResourceGroups.ps1 - skrypt, ktÃ³ry pobiera dane z pliku CSV gdzie jest spis Resource Group z tagami do wdroÅ¼enia.</li><li>SetTagsResources.ps1- skrypt, ktÃ³ry pobiera dane z pliku CSV gdzie zapisane mamy zasoby z tagami do wdroÅ¼enia.</li></ul><p>Taki podziaÅ‚ daje nam:</p><ol><li>Zapis stanu obecnego tagÃ³w zapisanych do pliku CSV. Jest to raport tagÃ³w czyli obecny stan wdroÅ¼ony tagÃ³w.</li><li>PodziaÅ‚ na grupy i zasoby.</li><li>MoÅ¼liwoÅ›Ä‡ poprawiania tagÃ³w tylko na zasobach lub tylko na grupach zasobÃ³w.</li></ol><p>Jak dziaÅ‚ajÄ… skrypty?</p><ol><li>GetAllTags<ol><li>Zapis do pliku odbywa siÄ™ automatycznie do lokalizacji gdzie wykonujemy skrypt lub moÅ¼emy uÅ¼yÄ‡ opcji -path gdzie majÄ… byÄ‡ zapisane pliki.</li><li>Nazwa pliku zawiera datÄ™, jeÅ›li plik istnieje zostanie on nadpisany.</li><li>Skrypt sprawdza czy jesteÅ› zalogowany do Azure. Podczas wykonywania skryptu moÅ¼esz podaÄ‡ parametr -tenantId, aby mieÄ‡&nbsp;pewnoÅ›Ä‡&nbsp;Å¼e logujesz siÄ™&nbsp;do odpowiedniego Azure Directory i -subId w celu wybrania subskrypcji.</li></ol></li><li>SetTagsResourceGroups oraz SetTagsResources<ol><li>Import danych z plikÃ³w odbywa siÄ™ automatycznie na podstawie konwencji nazewniczej wygenerowanego wczeÅ›niej pliku. Skrypt importuje najnowszy plik CSV we wskazanym katalogu. Istnieje podanie Å›cieÅ¼ki poprzez parametr -path.</li><li>Tagi powinny byÄ‡ oddzielone miÄ™dzy sobÄ… przecinkami.</li><li>Tagi zapisane w pliku CSV dziaÅ‚ajÄ… na zasadzie par â€œKey:Valueâ€ w osobnych kolumnach.</li><li>Skrypt pobiera wszystkie elementy z pliku CSV. NastÄ™pnie skrypt usuwa tagi w Microsoft Azure nastÄ™pnie wprowadzony z pliku CSV.</li><li>JeÅ›li nie chcemy danego zasobu ruszaÄ‡, wystarczy go usunÄ…Ä‡ z pliku CSV.</li><li>Skrypt dziaÅ‚a w trybie parallel co pozwala na szybsze wprowadzanie zmian. Throttle dla zapisu tagÃ³w wynosi 5, pamiÄ™taj, Å¼e jest to optymalna wartoÅ›Ä‡.</li><li>Skrypt sprawdza czy jesteÅ› zalogowany do Azure. Podczas wykonywania skryptu moÅ¼esz podaÄ‡ parametr -tenantId.</li><li>JeÅ›li chcesz wyczyÅ›ciÄ‡ tagi na zasobach wystarczy Å¼e zostawisz pustÄ… komÃ³rkÄ™&nbsp;lub wpiszesz â€œemptyâ€.</li><li>Wprowadzanie tagÃ³w moÅ¼emy testowaÄ‡&nbsp;wprowadzajÄ…c w pliku CSV tylko ten zasÃ³b ktÃ³ry chcemy zmieniÄ‡. Reszta zasobÃ³w nie bÄ™dzie brana pod uwagÄ™&nbsp;podczas wdraÅ¼ania tagÃ³w.</li></ol></li></ol><p>PoniÅ¼ej przedstawiam przykÅ‚ad jak to dziaÅ‚a na mojej subskrypcji.</p><p>Uruchomienie skryptu:</p><ul><li>GetAllTags.ps1</li></ul><p><code>Komenda: ./GetAllTags.ps1 -path /tags</code></p><p><img src="https://lh6.googleusercontent.com/g2uknxvVr-r8zuu_JNgHwzMEWXDS_lCkJkvP0w2nsaraF1iUI-PfsBGgFDAMnSqGiPEN-oG5sg0RR5aQWAqnixT1BRO0RBcsIWEpJ48Jfztk-ioLi0NlKg-fFfHPUxjXg60DReVG"></p><p>Na printscreenie moÅ¼esz zauwaÅ¼yÄ‡ output z informacjami jakie generowane sÄ… przez skrypt.</p><ul><li>Czy jesteÅ› zalogowany, jeÅ›li nie to poprosi CiÄ™ o zalogowanie siÄ™</li><li>IloÅ›Ä‡&nbsp;znalezionych grup zasobÃ³w oraz zasobÃ³w</li><li>Informacja gdzie i jakie pliki sÄ…&nbsp;tworzone</li><li>Lista zasobÃ³w</li></ul><p>Pliki CSV wyglÄ…dajÄ… nastÄ™pujÄ…co:</p><ul><li>Resource Group</li></ul><p><img src="https://lh3.googleusercontent.com/XiatuhcE3vx4Lr6g5rkz-JP48TjhJ-ydCdwySuAGgBccaVpVZKD9CfPF5xVpIuzU6IFM7PNj939dMpEviYAR3287SCr6F5y2cM4pu1i8500uzKNdRNSh16t8dX9GSosf7J2oDJFa"></p><ul><li>Resources</li></ul><p><img src="https://lh4.googleusercontent.com/m5u5NLpGw8DNyroSByMny-rIZsH11sZMs4tgFMixm_Lepfn0rjNf4XqLET6MvsT3YnK48PesD9GJQUkDtWJIuDKsUh7IolWD7BCDfHSQN4Ug_f6qdWpuPF2ns-8vRmnlRNtWptbp"></p><p>PoniÅ¼ej przedstawiÄ™ edycjÄ™ tagÃ³w dla pliku z zasobami.</p><p><em>Uwaga! JeÅ›li chcesz zachowaÄ‡ kopiÄ™ obecnego stanu, zabezpiecz wygenerowany plik lub zmieÅ„ jego nazwÄ™ na zupeÅ‚nie innÄ….</em>&nbsp;</p><p>Poprawiony plik wyglÄ…da nastÄ™pujÄ…co. ZauwaÅ¼, Å¼e wypeÅ‚niÅ‚em tagi dla wszystkich obiektÃ³w oraz dodaÅ‚em nowy tag: Test:Key, aby pokazaÄ‡ jak wyglÄ…da przypisywanie wielu tagÃ³w.</p><p><img src="https://lh6.googleusercontent.com/q4_FhHhAden4hD-gq6IJjhVRras8g-lAgwqCo4evhui6_dSF1wjIt6rZwHV23YbOWIuvlJihRbleddX46VkkUudBByLuX_lfGlrab1_U8Ya14-pdg9Xhrqd7hdzoQqpsxwaseZle"></p><p>Wynik skryptu z wykonanymi zmianami:</p><p><code>Komenda: ./SetTagsResources.ps1 -path /tags</code></p><p><img src="https://lh4.googleusercontent.com/49zIzivJeCzwtGRSBFcnzG4X0nr3nbtc1dxgJag7q3_tocRbvBcgu0m_DUf11179BBt1GWpHQalOmsyis3CDnEX3xCpgt-1w1Ic_-bR8KFREpnCOP-aXCxmAjefbS7mU7qJbRvkL"></p><p>Efekt zmian w Portalu Azure:</p><p><img src="https://lh4.googleusercontent.com/O0XGlppGQzJYWYNOJcfKkxTo0ZcT4Hstc46TWolZUIr4Bi80Tq8P60Z1IwlMDgU-vwQ4yLvuj1cYWb9RYy67Z4BDPvFGjx704b9ZYUVbGNb9EFUatChC8Vv3YnHQi4g_1Lr1ciL2"></p><p>Skrypt moÅ¼na dostosowaÄ‡&nbsp;do swoich celÃ³w tak, aby dziaÅ‚aÅ‚ na przykÅ‚ad dla wielu subskrypcji. Jest wiele opcji customizacji tego skryptu, ktÃ³re celowo pominÄ…Å‚em. Skrypty dziaÅ‚ajÄ… moduÅ‚owo wiÄ™c moÅ¼na ich Å‚atwo uÅ¼yÄ‡ z innym skryptem, a reszta zostanie przygotowana i wdroÅ¼ona na podstawie wprowadzonych danych z pliku.</p><p>Zapraszam do pozostawienia komentarza!</p>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="azutomation" term="azutomation"/>
        <category label="csv" term="csv"/>
        <category label="microsoft azure" term="microsoft azure"/>
        <category label="raport" term="raport"/>
        <category label="report" term="report"/>
        <category label="tag" term="tag"/>
        <category label="tagging" term="tagging"/>
        <category label="tags" term="tags"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[WysÅ‚anie Å¼Ä…dania API z PowerShell do Azure DevOps]]></title>
        <id>wyslanie-zadania-api-z-powershell-do-azure-devops</id>
        <link href="https://blog.justcloud.pl/wyslanie-zadania-api-z-powershell-do-azure-devops"/>
        <updated>2020-04-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[PowerShell to nie tylko automatyzacja za pomocÄ… moduÅ‚Ã³w. MoÅ¼emy go rÃ³wnieÅ¼ wykorzystaÄ‡ do wysyÅ‚ania zapytaÅ„ za pomocÄ… API do rÃ³Å¼nych serwisÃ³w. W tym artykule zobaczysz jak to zrobiÄ‡.]]></summary>
        <content type="html"><![CDATA[<p>CzÄ™sto stajemy przed wyzwaniem zintegrowania ze sobÄ… wielu narzÄ™dzi. JeÅ¼eli stosujemy PowerShell w celu automatyzacji swojej infrastruktury bÄ…dÅº budowy prostych skryptÃ³w moÅ¼e nam siÄ™ przydaÄ‡ zastosowanie uÅ¼ycia wywoÅ‚ania Å¼Ä…dania API za pomocÄ… PowerShell. PoniÅ¼szy przykÅ‚ad zaprezentuje uÅ¼ycie wysÅ‚ania Å¼Ä…dania za pomocÄ… API do Azure DevOps w celu dodania puli agentowej.</p><p>Referencje API do Azure DevOps sÄ… dostÄ™pne tutaj:&nbsp;</p><p><a href="https://docs.microsoft.com/en-us/rest/api/azure/devops/distributedtask/pools/add?view=azure-devops-rest-5.1" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/rest/api/azure/devops/distributedtask/pools/add?view=azure-devops-rest-5.1</a></p><p>PoniÅ¼szy przykÅ‚adowy skrypt moÅ¼emy rozbudowaÄ‡ dla innych operacji stosujÄ…c odpowiedni uri dla potrzebnej operacji z powyÅ¼szego linku.  </p><p>Na poczÄ…tku definiujemy zmienne:  </p><ul><li>$urlvsts - URL do naszego projektu Azure DevOps</li><li>$token - PAT token (Instrukcja jak wygenerowaÄ‡ token: <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=preview-page" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/use-personal-access-tokens-to-authenticate?view=azure-devops&amp;tabs=preview-page</a>)</li><li>$pool - nazwa puli, ktÃ³rÄ… chcemy utworzyÄ‡</li><li>$encodedPat - przekonwertowanie tokenu na SecureString</li><li>$body - informacje do przekazania w wysyÅ‚anym Å¼Ä…daniu</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$urlvsts = 'https://dev.azure.com/PROJECT-NAME'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$token = 'YOUR-PAT-TOKEN'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$pool = 'YOUR-POOL-NAME'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$encodedPat = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes( ":$token"))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$body = "{name:`"$pool`", autoProvision: `"true`"}"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Komenda <code>Invoke-WebRequest</code> wykonuje wysÅ‚ania Å¼Ä…dania podajÄ…c wczeÅ›niej zdefiniowane zmienne oraz zawiera Uri, czyli miejsce, w ktÃ³re zapuka Å¼Ä…danie, aby ustawiÄ‡ nowÄ… pulÄ™ w Azure DevOps.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Invoke-WebRequest `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -Method POST `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -Uri "$urlvsts/_apis/distributedtask/pools?api-version=5.0-  preview.1" `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -UseBasicParsing `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -Headers @{Authorization = "Basic $encodedPat"} `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -Body $body `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -ContentType "application/json"</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Screens:</p><p>Code:</p><p><img src="/assets/images/2020-04-13_14h12_09-74a67a70a3044a95c8342ca461fd26c3.png" width="1013" height="314"></p><p>Output:</p><p><img src="/assets/images/2020-04-13_14h12_53-b564469a0b3f4a59f61d76185b092578.png" width="2009" height="523"></p><p>Azure DevOps:</p><p><img src="/assets/images/2020-04-13_14h14_02-1024x604-e6cc533454530d607213bf2bb5b3ea5c.png" width="1024" height="604"></p><p>W prosty sposÃ³b moÅ¼emy teraz zautomatyzowaÄ‡ operacje w Azure DevOps bez uruchamiania portalu. Niestety referencje API dla Azure DevOps nie pozwalajÄ… na wszystko co moÅ¼emy wyklikaÄ‡ w portalu, ale na pewno pomoÅ¼e to w osiÄ…gniÄ™ciu celu. JeÅ›li masz ciekawe przypadki uÅ¼ycia wspomnianego API lub zastanawiasz siÄ™, gdzie moÅ¼na tego uÅ¼yÄ‡ zapraszam do komentowania.</p><p>UÅ¼ycie skryptu moÅ¼ecie rÃ³wnieÅ¼ sprawdziÄ‡ w deploymencie puli agentÃ³w dla Azure DevOps tutaj: <a href="https://github.com/RogalaPiotr/JustCloudPublic/blob/master/simple-vm-with-installation-vsts-agent/vstsagent.ps1" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/blob/master/simple-vm-with-installation-vsts-agent/vstsagent.ps1</a></p><p>ArtykuÅ‚ dostÄ™pny rÃ³wnieÅ¼ na Medium i LinkedIN:</p><ul><li>(EN) <a href="https://medium.com/@piotr.rogala/api-request-to-azure-devops-from-powershell-2e2f525dbd7a" target="_blank" rel="noopener noreferrer">https://medium.com/@piotr.rogala/api-request-to-azure-devops-from-powershell-2e2f525dbd7a</a></li><li>(PL) <a href="https://www.linkedin.com/pulse/wys%C5%82anie-%C5%BC%C4%85dania-api-z-powershell-do-azure-devops-piotr-rogala" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/pulse/wys%C5%82anie-%C5%BC%C4%85dania-api-z-powershell-do-azure-devops-piotr-rogala</a></li></ul>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="api" term="api"/>
        <category label="automation" term="automation"/>
        <category label="azure" term="azure"/>
        <category label="azure devops" term="azure devops"/>
        <category label="powershell" term="powershell"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[IaC control via PowerShell module for ARM templates]]></title>
        <id>iac-control-via-powershell-module-for-arm-templates</id>
        <link href="https://blog.justcloud.pl/iac-control-via-powershell-module-for-arm-templates"/>
        <updated>2019-09-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Walidowanie szablonÃ³w ARM za pomocÄ… moduÅ‚u PowerShell jest moÅ¼liwe dziÄ™ki nowemu moduÅ‚owi. UÅ¼ycie tego moduÅ‚u pomoÅ¼e Ci sprawdziÄ‡ czy szablon jest poprawny i jakie zmiany wprowadzi na wdraÅ¼anym Å›rodowisku Azure.]]></summary>
        <content type="html"><![CDATA[<p>Debug natywnych szablonÃ³w ARM jest ciÄ™Å¼kim procesem dla wielu osÃ³b. Utrzymanie infrastruktury jako kod rÃ³wnieÅ¼ nie jest prostÄ… sprawÄ…, dlatego czÄ™sto uÅ¼ywa siÄ™ Terraforma dla wdroÅ¼eÅ„ w Microsoft Azure.</p><p>Szablony ARM nie posiadajÄ… pliku stanu jak to jest w Terraform dlatego czÄ™sto spotykam siÄ™ z opiniÄ…, Å¼e, ARM'y sÄ… beznadziejnie. Po wdroÅ¼eniu trudno jest utrzymaÄ‡ staÅ‚y rozwÃ³j infrastruktury z tego samego szablonu oraz czÄ™sto problemem jest przewidywalnoÅ›Ä‡ co siÄ™ stanie z obiektami, ktÃ³re juÅ¼ masz. Nie bÄ™dÄ™ siÄ™ rozwodziÅ‚ co lepsze co gorsze, poniewaÅ¼ wiele zaleÅ¼y od naszej wiedzy, podejÅ›cia, problemu lub zlecenia, ktÃ³re wykonujemy. Jako InÅ¼ynier nie przywiÄ…zuje siÄ™ do rozwiÄ…zaÅ„ i uwaÅ¼am, Å¼e do kaÅ¼dego problemu naleÅ¼y podchodziÄ‡ indywidualnie. Moim zdaniem najlepsze rozwiÄ…zania to rozwiÄ…zania natywne nie wymagajÄ…ce tworzenia koÅ‚a na nowo. StÄ…d zachÄ™cam do pisania szablonÃ³w ARM dla Azure.</p><p>Jako pomoc w tworzeniu infrastruktury jako kod (IaC) w Microsoft Azure polecam zapoznaÄ‡ siÄ™ z moduÅ‚em PowerShell: <strong>ARMHelper</strong></p><p><a href="https://www.powershellgallery.com/packages/ARMHelper/0.6.2" target="_blank" rel="noopener noreferrer">https://www.powershellgallery.com/packages/ARMHelper/0.6.2</a></p><p>Za pomocÄ… komendy: Test-ARMExistingResource moÅ¼emy zbudowaÄ‡ polecenie, ktÃ³re sprawdzi nam wskazany szablon w kontekÅ›cie z deploy'owanych zasobÃ³w w Azure i wyÅ›wietli co siÄ™ stanie. PrzykÅ‚ad poniÅ¼ej przedstawia stworzonÄ… resource groupe bez zasobÃ³w:</p><p>UÅ¼yÅ‚em szablonu z mojego repo: <a href="https://github.com/RogalaPiotr/JustCloudPublic/tree/master/simple-vm-shutdown-on-time" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/tree/master/simple-vm-shutdown-on-time</a><br>
<!-- -->Wykonuje kolejno komendy:</p><p>Tworzenie nowej resource groupy:</p><p><code>New-AzResourceGroup -Name 'simple-vm-shutdown-on-time' -Location westeurope</code></p><p>Sprawdzenie co wyÅ›wietli poleniecenie Test-ARMExistingResource:</p><p><code>Test-ARMExistingResource -ResourceGroupName 'simple-vm-shutdown-on-time' -TemplateFile .\azuredeploy.json -TemplateParameterFile .\azuredeploy.parameters.json -Verbose</code></p><p><img src="/assets/images/2019-09-15_12h46_05-8727ff774509b20d633ad59e6525eba9.png" width="1732" height="565"></p><p>Wynikiem jest informacja co zostanie utworzone. Super sprawa, to teraz zrobie deployment szablonu i sprawdzimy ponownie.</p><p><code>New-AzResourceGroupDeployment -ResourceGroupName 'simple-vm-shutdown-on-time' -TemplateFile .\azuredeploy.json -TemplateParameterFile .\azuredeploy.parameters.json -Verbose</code></p><p>Niestety miaÅ‚em problem z moduÅ‚em Shutdown i szablon wdroÅ¼yÅ‚ siÄ™ niepoprawnie, dlatego sprawdziÅ‚em co wyÅ›wietli Test-ARMExistResource.</p><p><code>Test-ARMExistingResource -ResourceGroupName 'simple-vm-shutdown-on-time' -TemplateFile .\azuredeploy.json -TemplateParameterFile .\azuredeploy.parameters.json -Verbose</code></p><p><img src="/assets/images/2019-09-15_13h01_42-e2df42c028dec7e6b2a418ca36325840.png" width="1738" height="457"></p><p>Jak widaÄ‡ polecenie poprawnie zwrÃ³ciÅ‚o co jest do poprawienia i co zostanie zmienione(inkrementalnie).</p><p>Ostatni test to z argumentem "-Mode Complete" czyli wykonanie szablonu, ktÃ³ry dostosuje wszystkie zasoby niezaleÅ¼nie od tego co jest stworzone w resource groupie do mojego szablonu.</p><p><code>Test-ARMExistingResource -ResourceGroupName 'simple-vm-shutdown-on-time' -TemplateFile .\azuredeploy.json -TemplateParameterFile .\azuredeploy.parameters.json -Verbose -Mode Complete</code></p><p><img src="/assets/images/2019-09-15_13h02_32-cbf72f27f5da36e8dfc3c71bbaebd55f.png" width="1824" height="587"></p><p>Teraz moÅ¼na byÄ‡ pewniejszym co siÄ™ stanie z wdroÅ¼eniem po maÅ‚ych zmianach w szablonie.</p><p>Mam nadzieje Å¼e przyda Ci siÄ™ ta wiedza :)</p>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="arm" term="arm"/>
        <category label="azure" term="azure"/>
        <category label="iac" term="iac"/>
        <category label="module" term="module"/>
        <category label="powershell" term="powershell"/>
        <category label="templates" term="templates"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[SkÄ…d uczyÄ‡ siÄ™ o Microsoft Azure?]]></title>
        <id>skad-uczyc-sie-o-microsoft-azure</id>
        <link href="https://blog.justcloud.pl/skad-uczyc-sie-o-microsoft-azure"/>
        <updated>2018-11-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Chcesz zaczÄ…Ä‡ nauke o Microsoft Azure? W tym artykule znajdziesz linki, ktÃ³re napewno CiÄ™ zainteresujÄ…!]]></summary>
        <content type="html"><![CDATA[<p>Po ostatniej prezentacji naszedÅ‚ mnie pomysÅ‚ zwiÄ…zany z utworzeniem miejsca skÄ…d moÅ¼na siÄ™ uczyÄ‡ chmury Microsoft Azure. StÄ…d postanowiÅ‚em zebraÄ‡ interesujÄ…ce linki w jednym miejscu gdzie znajdziecie rekomendowane przeze mnie jak i przez innych ekspertÃ³w miejsca do nauki. WiÄ™kszoÅ›Ä‡ z poniÅ¼szych linkÃ³w jest darmowa i takie bÄ™dÄ™ staraÅ‚ siÄ™ udostÄ™pniaÄ‡. JeÅ›li chciaÅ‚byÅ› dodaÄ‡ ciekawe miejsce, ktÃ³re rekomendujesz dodaj je w komentarzu, pomoÅ¼e to w udoskonaleniu listy.</p><p>JeÅ›li wiesz czego konkretnie szukasz moÅ¼esz uÅ¼yÄ‡ wyszukiwarki aby skoncentrowaÄ‡ siÄ™ na danym problemie: </p><p><a href="https://www.youtube.com/watch?v=Rkxg03z2PEo" target="_blank" rel="noopener noreferrer"><img src="https://img.youtube.com/vi/Rkxg03z2PEo/0.jpg"></a></p><p>A, tak na powaÅ¼nie moÅ¼esz zaczerpnÄ…Ä‡ wiedzy w poniÅ¼szych miejscach.</p><p>Grupa Microsoft Azure User Group Poland na Facebook'u:&nbsp;<a href="https://www.facebook.com/groups/azureugpl/" target="_blank" rel="noopener noreferrer">https://www.facebook.com/groups/azureugpl/</a></p><p><strong>Video:</strong></p><ul><li>Azure Developer:&nbsp;<a href="https://docs.microsoft.com/pl-pl/learn/browse/?roles=developer&amp;products=azure" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/pl-pl/learn/browse/?roles=developer&amp;products=azure</a></li><li>Azure Administrator:&nbsp;<a href="https://docs.microsoft.com/pl-pl/learn/browse/?roles=administrator&amp;products=azure" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/pl-pl/learn/browse/?roles=administrator&amp;products=azure</a></li><li>Azure Solution Architect:&nbsp;<a href="https://docs.microsoft.com/pl-pl/learn/browse/?roles=solution-architect&amp;products=azure" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/pl-pl/learn/browse/?roles=solution-architect&amp;products=azure</a></li><li>Azure Friday:&nbsp;<a href="https://channel9.msdn.com/Shows/Azure-Friday" target="_blank" rel="noopener noreferrer">https://channel9.msdn.com/Shows/Azure-Friday</a></li><li>Microsoft Self-paced Labs:&nbsp;<a href="https://www.microsoft.com/handsonlabs/selfpacedlabs" target="_blank" rel="noopener noreferrer">https://www.microsoft.com/handsonlabs/selfpacedlabs</a></li><li>Microsoft Virtual Academy:&nbsp;<a href="https://mva.microsoft.com/search/SearchResults.aspx#!q=azure&amp;orderby=publishedtime&amp;lang=1033" target="_blank" rel="noopener noreferrer">https://mva.microsoft.com/search/SearchResults.aspx#!q=azure&amp;orderby=publishedtime&amp;lang=1033</a></li><li>Azure Tips and Tricks:&nbsp;<a href="https://www.michaelcrump.net/azure-tips-and-tricks-complete-list/" target="_blank" rel="noopener noreferrer">https://www.michaelcrump.net/azure-tips-and-tricks-complete-list/</a></li><li>Pluralsight:&nbsp;<a href="https://www.pluralsight.com/search?q=azure" target="_blank" rel="noopener noreferrer">https://www.pluralsight.com/search?q=azure</a></li></ul><p><strong>Blogi&nbsp;Polskich ekspertÃ³w:</strong></p><ul><li>MichaÅ‚ Furmankiewicz: <a href="http://cloudarchitects.pl/" target="_blank" rel="noopener noreferrer">http://cloudarchitects.pl/</a></li><li>MichaÅ‚ SmereczyÅ„ski: <a href="https://lnx.azurewebsites.net/" target="_blank" rel="noopener noreferrer">https://lnx.azurewebsites.net/</a></li><li>Emil Wasilewski:&nbsp;<a href="http://zapytajemila.pl/" target="_blank" rel="noopener noreferrer">http://zapytajemila.pl/</a></li><li>Åukasz KaÅ‚uÅ¼ny:&nbsp;<a href="https://kaluzny.io/" target="_blank" rel="noopener noreferrer">https://kaluzny.io/</a></li><li>Sebastian Fyda:&nbsp;<a href="http://blog.spiderweb.pl/" target="_blank" rel="noopener noreferrer">http://blog.spiderweb.pl/</a></li><li>Piotr Rogala:&nbsp;<a href="https://justcloud.azurewebsites.net/blog/" target="_blank" rel="noopener noreferrer">https://justcloud.azurewebsites.net/blog/</a></li><li>Szymon Pulka (DEV):&nbsp;<a href="https://devincloud.pl/" target="_blank" rel="noopener noreferrer">https://devincloud.pl/</a></li><li>Mateusz Dudek (DEV):&nbsp;<a href="https://mateuszdudek.pl/blog/" target="_blank" rel="noopener noreferrer">https://mateuszdudek.pl/blog/</a></li></ul><p><strong>Book's</strong></p><ul><li>Free eBooks from Microsoft Press<ul><li>Microsoft Azure Essentials: Fundamentals of Azure, Second Edition</li><li>Introduction to Windows Containers</li><li>Microsoft Azure Essentials Migrating SQL Server Databases to Azure</li><li>Microsoft Azure Essentials: Azure Web Apps for Developers</li></ul></li><li>The Developerâ€™s Guide to Microsoft Azure:&nbsp;<a href="https://azure.microsoft.com/en-us/blog/free-ebook-the-developer-s-guide-to-microsoft-azure-now-available/" target="_blank" rel="noopener noreferrer">https://azure.microsoft.com/en-us/blog/free-ebook-the-developer-s-guide-to-microsoft-azure-now-available/</a></li></ul><p><strong>Certyfikaty:</strong></p><ul><li>Lista moÅ¼liwych certyfikatÃ³w do zrobienia dot. Azure:&nbsp;<a href="https://www.microsoft.com/en-us/learning/azure-exams.aspx" target="_blank" rel="noopener noreferrer">https://www.microsoft.com/en-us/learning/azure-exams.aspx</a></li></ul>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="azure" term="azure"/>
        <category label="course" term="course"/>
        <category label="courses" term="courses"/>
        <category label="kurs" term="kurs"/>
        <category label="kursy" term="kursy"/>
        <category label="learn" term="learn"/>
        <category label="microsoft azure" term="microsoft azure"/>
        <category label="nauka" term="nauka"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Auto deployment VM with VSTS agent for pool]]></title>
        <id>auto-deployment-vm-with-vsts-agent-for-pool</id>
        <link href="https://blog.justcloud.pl/auto-deployment-vm-with-vsts-agent-for-pool"/>
        <updated>2018-05-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Azure DevOps agent to waÅ¼ny element wszystkich wdroÅ¼eÅ„. Potrzebujesz stworzyÄ‡ wÅ‚asnego agenta ADO? Zobacz jak to zrobiÄ‡ w prosty i automatyczny sposÃ³b! Wszystko znajdziesz we wpisie.]]></summary>
        <content type="html"><![CDATA[<p>Wszyscy ktÃ³ry robiÄ… depyolemnty z VSTS spotykajÄ… siÄ™ z sytuacjÄ…, kiedy standardowe 240min siÄ™ koÅ„czy i trzeba stworzyÄ‡ sobie takÄ… maszynÄ™. Sam robiÅ‚em takÄ… maszynÄ™ parÄ™ razy i kiedy znÃ³w pojawiÅ‚a siÄ™ ta koniecznoÅ›Ä‡ postanowiÅ‚em stworzyÄ‡ automatyczny deployment ktÃ³ry nam stworzy z JSON'a caÅ‚a maszynkÄ™ i podepnie jÄ… do Agent pool w VSTS.</p><p>MiaÅ‚em parÄ™ pomysÅ‚Ã³w, aby zrobiÄ‡ bardzo uniwersalny template ktÃ³ry nie tylko przyda siÄ™ wam, ale rÃ³wnieÅ¼ mi w przyszÅ‚oÅ›ci do budowania innych szablonÃ³w. TakÅ¼e w skrÃ³cie opiszÄ™ ciekawostki ktÃ³re zastosowaÅ‚em szablonie, ktÃ³ry znajdziecie na moim GitHubie.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="githubhttpsgithubcomrogalapiotrjustcloudpublictreemastersimple-vm-with-installation-vsts-agent"><strong>GitHub</strong>:&nbsp;<a href="https://github.com/RogalaPiotr/JustCloudPublic/tree/master/simple-vm-with-installation-vsts-agent" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/tree/master/simple-vm-with-installation-vsts-agent</a><a class="hash-link" href="#githubhttpsgithubcomrogalapiotrjustcloudpublictreemastersimple-vm-with-installation-vsts-agent" title="Direct link to heading">â€‹</a></h5><p>ZaÅ‚oÅ¼enie dotyczÄ…ce szablonu: chciaÅ‚bym dodaÄ‡ informacjÄ™, gdzie waÅ¼nym jest zwrÃ³cenie uwagi, Å¼e maszyna ma byÄ‡ odizolowana od naszej sieci wewnÄ™trznej, dlatego szablon jest infrastruktura stand alone, aby byÅ‚o bezpiecznie i w razie czego moÅ¼na jÄ… usunÄ… lub powoÅ‚aÄ‡ wiÄ™cej agentÃ³w do deploymentâ€™Ã³w.</p><h1>Opis szablonu</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="sekcja-parameters"><strong>Sekcja Parameters:</strong><a class="hash-link" href="#sekcja-parameters" title="Direct link to heading">â€‹</a></h2><p>w tej sekcji podajemy dane ktÃ³re przydadzÄ… nam siÄ™ do deplymentâ€™u i automatycznego podÅ‚Ä…czenia do VSTS'a.</p><ul><li><strong>adminUsername</strong>, <strong>adminPassword</strong> - lokalny uÅ¼ytkownik i hasÅ‚o,</li><li><strong>dnsLabelPrefix</strong> - zostanie automatycznie wygenerowany podczas deploymentâ€™u, wiÄ™c nie ma koniecznoÅ›ci go zmieniaÄ‡,</li><li><strong>vmName</strong> - nazwa naszej maszyny oraz na podstawie tej nazwy zostanÄ… nazwane wszystkie nasze resource jest: VNET, NSG, Storage...</li><li><strong>urlvsts</strong> - adres do naszego projektu VSTS np.: <a href="https://project1.visualstudio.com" target="_blank" rel="noopener noreferrer">https://project1.visualstudio.com</a>,</li><li><strong>auth</strong> - rodzaj poÅ›wiadczenia - wybrany domyÅ›lnie PAT,</li><li><strong>token</strong> - token security ktÃ³ry umoÅ¼liwi nam podÅ‚Ä…czenie siÄ™ do projektu. WiÄ™cej informacji jak stworzyÄ‡ Security Token poniÅ¼ej:<ul><li><a href="https://docs.microsoft.com/en-us/vsts/build-release/actions/agents/v2-windows?view=vsts" target="_blank" rel="noopener noreferrer"><strong>https://docs.microsoft.com/en-us/vsts/build-release/actions/agents/v2-windows?view=vsts</strong></a></li></ul></li><li><strong>pool</strong> - nazwa puli, do ktÃ³rej zostanie dodana maszyna w VSTS'ie - ustawiony jest na default</li><li><strong>AccessIPNSG</strong> - adres, ktÃ³ry tutaj podacie zostanie dodany do NSG i tylko z tego adresu dostaniecie siÄ™ po RDP do maszyny,</li><li><strong>Tag</strong> - tagi mogÄ… ulec waszej modyfikacji ustawione sÄ… na Project: VSTSAgent.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="sekcja-variables"><strong>Sekcja Variables:</strong><a class="hash-link" href="#sekcja-variables" title="Direct link to heading">â€‹</a></h2><ul><li><strong>vmsize</strong> - ustawiony na "Standard<!-- -->_<!-- -->B1s" - dosyÄ‡ tani i wystarczajÄ…cy na maszynÄ™ deploymentâ€™owy - pamiÄ™taj, aby sprawdziÄ‡, czy masz moÅ¼liwoÅ›Ä‡ deployâ€™owania tej maszyny w swojej subskrypcji w innym przypadku zgÅ‚oÅ› request do supportu Microsoft w celu uruchomienia wielkoÅ›ci B<!-- -->_<!-- -->size.</li><li><strong>urldonwloadagent</strong> - w tym miejscu jest podany link do Å›ciÄ…gniÄ™cia aktualnego zip'a z agentem VSTS - w razie zmiany wersji naleÅ¼y zaktualizowaÄ‡ link na aktualny</li><li><strong>filescriptURI</strong> - skrypt napisany przeze mnie w celu automatycznego pobrania i zainstalowania agenta na maszynie:&nbsp;<a href="https://raw.githubusercontent.com/RogalaPiotr/JustCloudPublic/master/simple-vm-with-installation-vsts-agent/vstsagent.ps1" target="_blank" rel="noopener noreferrer">https://raw.githubusercontent.com/RogalaPiotr/JustCloudPublic/master/simple-vm-with-installation-vsts-agent/vstsagent.ps1</a></li><li><strong>filescriptURISplit</strong> - bardzo ciekawa funkcja, ktÃ³ra rozbija powyÅ¼szy url na tekst tam, gdzie jest slah "/" co w efekcie generuje nam obiekt<ul><li>wiÄ™cej ciekawych informacji w dokumentacji Microsoft:&nbsp;<strong><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-functions" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-template-functions</a></strong></li></ul></li><li><strong>filescriptName</strong> - kolejna fajna funkcja, gdzie na podstawie powyÅ¼szego splita zabieramy nazwÄ™ skryptu, ktÃ³ry posÅ‚uÅ¼y nam do instalacji w CustomScriptExtension,</li><li><strong>agentname</strong> - kaÅ¼dy dodany Agent do puli w VSTS bÄ™dzie nosiÅ‚ nazwÄ™ NazwaMaszynyagent.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="sekcja-resources"><strong>Sekcja Resources:</strong><a class="hash-link" href="#sekcja-resources" title="Direct link to heading">â€‹</a></h2><ul><li><strong>type: Microsoft.Network/networkSecurityGroups</strong> - NSG z dostÄ™pem RDP tylko z adresu IP ktÃ³ry dodamy podczas deployâ€™mentu parametr: AccessIPNSG</li><li><strong>type: Microsoft.Network/publicIPAddresses</strong> - Publiczny adres dla naszej VM, aby mÃ³c siÄ™ do niej podÅ‚Ä…czyÄ‡ z zewnÄ…trz.</li><li><strong>type: Microsoft.Network/virtualNetworks</strong> - VNet</li><li><strong>type: Microsoft.Compute/virtualMachines</strong> - tworzenie maszyny wirtualnej z Windows 2016 i Managed Disk<ul><li><strong>type: Microsoft.Compute/virtualMachines/extensions</strong> - instalacja agenta VSTS, bazujÄ…c na napisanym skrypcie i udostÄ™pnionym na GitHubie:&nbsp;vstsagent.ps1 zostanie on uÅ¼yty podczas deplyomentâ€™u a podczas jego wykonywaniu dodamy informacjÄ™ zwiÄ…zane z url VSTS, tokenem itp. PeÅ‚na komenda w linii 257: "commandToExecute"</li></ul></li><li><strong>type: Microsoft.DevTestLab/schedules</strong> - dziÄ™ki temu nasza maszynie bÄ™dzie wyÅ‚Ä…czana codziennie o 18:00 zona: W. Europe Standard Time - ten feature dziaÅ‚a tylko kiedy maszyna jest wÅ‚Ä…czona pozwoli to nam zapomnieÄ‡ o wyÅ‚Ä…czaniu, a mimo wszystko nie bÄ™dziemy traciÄ‡ pieniÄ™dzy za jej bezczynnoÅ›Ä‡.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="sekcja-outputs"><strong>Sekcja Outputs:</strong><a class="hash-link" href="#sekcja-outputs" title="Direct link to heading">â€‹</a></h2><ul><li><strong>PublicDNS</strong> - po wykonaniu deploymentâ€™u wyÅ›wietli nam publiczny adres DNS dla VM,</li><li><strong>Hostname</strong> - wyÅ›wietli nazwÄ™ maszyny, ktÃ³rÄ… wprowadziliÅ›my w parametrach,</li><li><strong>VSTSAgentName</strong> - wyÅ›wietli nazwÄ™ agenta jaka bÄ™dzie widoczna w VSTS,</li><li><strong>VSTSProjectName</strong> - wyÅ›wietli nazwÄ™ projektu VSTS jaki zostaÅ‚ wprowadzony,</li><li><strong>ScriptURI</strong> - wyÅ›wietli ÅºrÃ³dÅ‚o z jakiego zostaÅ‚ pobrany skrypt do instalacji Agenta,</li><li><strong>AccessRDPFrom</strong> - wyÅ›wietli adres IP ktÃ³ry zostaÅ‚ dodany do NSG, aby miaÅ‚ dostÄ™p do RDP</li></ul><h1>Szablon:</h1><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "contentVersion": "1.0.0.0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "parameters": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "adminUsername": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Username for the Virtual Machine."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "adminPassword": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "securestring",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Password for the Virtual Machine."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "dnsLabelPrefix": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "defaultValue": "[concat('x', uniqueString(resourceGroup().id))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "vmName": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "urlvsts": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "URL for your VSTS Project ex. https://project1.visualstudio.com."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "auth": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "defaultValue": "pat",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "token": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "securestring",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Security token for VSTS project."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "pool": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Pool name in VSTS - Default is a main."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "AccessIPNSG": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Your publif IP it will added for NSG for connection via RDP."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "numberagents": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "int",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "description": "Numbers of agents for installation"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "tag": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "metadata": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "description": "Tag Values"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "variables": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "storageAccountName": "[concat('stor', uniquestring(resourceGroup().id))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "windowsOSVersion": "2019-Datacenter",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "vmsize": "Standard_B2ms",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "publicIPAddressName": "[concat(parameters('vmName'), '-pip')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "virtualNetworkName": "[concat(parameters('vmName'), '-vnet')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "NSGname": "[concat(parameters('vmName'), '-nsg')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "nicName": "[concat(parameters('vmName'), '-nic')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "subnetName": "[concat(parameters('vmName'), '-subnet')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "addressPrefix": "10.0.0.0/16",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "subnetPrefix": "10.0.0.0/24",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('subnetName'))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "urldonwloadagent": "https://vstsagentpackage.azureedge.net/agent/2.155.1/vsts-agent-win-x64-2.155.1.zip",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "filescriptURI": "https://raw.githubusercontent.com/RogalaPiotr/JustCloudPublic/master/simple-vm-with-installation-vsts-agent/vstsagent.ps1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "filescriptURISplit": "[split(variables('filescriptURI'), '/')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "filescriptName": "[last(variables('filescriptURISplit'))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "agentname": "[parameters('vmName')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "resources": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.Storage/storageAccounts",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[variables('storageAccountName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2015-06-15",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "accountType": "Standard_LRS"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.Network/networkSecurityGroups",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[variables('NSGName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2018-03-01",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "securityRules": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "name": "RDP",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "description": "Allow IP for RDP",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "protocol": "TCP",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "sourcePortRange": "*",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "destinationPortRange": "3389",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "sourceAddressPrefix": "[parameters('AccessIPNSG')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "destinationAddressPrefix": "*",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "access": "Allow",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "priority": 100,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "direction": "Inbound"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2016-03-30",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.Network/publicIPAddresses",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[variables('publicIPAddressName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "publicIPAllocationMethod": "Dynamic",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "dnsSettings": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "domainNameLabel": "[parameters('dnsLabelPrefix')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2016-03-30",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.Network/virtualNetworks",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[variables('virtualNetworkName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "dependsOn": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "[resourceId('Microsoft.Network/networkSecurityGroups/', variables('NSGName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "addressSpace": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "addressPrefixes": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "[variables('addressPrefix')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "subnets": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "name": "[variables('subnetName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "addressPrefix": "[variables('subnetPrefix')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "networkSecurityGroup": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "id": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('NSGName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2016-03-30",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.Network/networkInterfaces",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[variables('nicName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "dependsOn": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "[resourceId('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "[resourceId('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "ipConfigurations": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "name": "ipconfig1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "privateIPAllocationMethod": "Dynamic",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "publicIPAddress": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "subnet": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "id": "[variables('subnetRef')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2016-04-30-preview",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.Compute/virtualMachines",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[parameters('vmName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "dependsOn": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "[resourceId('Microsoft.Network/networkInterfaces/', variables('nicName'))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "licenseType": "Windows_Server",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "hardwareProfile": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "vmSize": "[variables('vmsize')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "osProfile": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "computerName": "[parameters('vmName')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "adminUsername": "[parameters('adminUsername')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "adminPassword": "[parameters('adminPassword')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "storageProfile": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "imageReference": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "publisher": "MicrosoftWindowsServer",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "offer": "WindowsServer",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "sku": "[variables('windowsOSVersion')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "version": "latest"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "osDisk": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "name": "[concat(parameters('vmName'),'-os')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "vhd": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "uri": "[concat('http://',variables('storageAccountName'),'.blob.core.windows.net/vhds/',parameters('vmName'),'-vm-os.vhd')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "caching": "ReadWrite",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "createOption": "FromImage"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "networkProfile": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "networkInterfaces": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "resources": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "name": "[concat(parameters('vmName'),'/AzureDevOpsAgentInstall')]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "type": "Microsoft.Compute/virtualMachines/extensions",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "dependsOn": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "apiVersion": "2015-06-15",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "publisher": "Microsoft.Compute",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "type": "CustomScriptExtension",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "typeHandlerVersion": "1.9",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "autoUpgradeMinorVersion": true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "settings": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "fileUris": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "[variables('filescriptURI')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "protectedSettings": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File ',variables('filescriptName'),' -url ',variables('urldonwloadagent'),' -urlvsts ',parameters('urlvsts'),' -auth ',parameters('auth'),' -token ',parameters('token'),' -pool ',parameters('pool'),' -agentname ',variables('agentname'), ' -numberagents ',parameters('numberagents'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "apiVersion": "2016-05-15",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type": "Microsoft.DevTestLab/schedules",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "name": "[concat('shutdown-computevm-', parameters('vmName'))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "location": "[resourceGroup().location]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "tags": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Project": "[parameters('tag')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "dependsOn": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "[resourceId('Microsoft.Compute/virtualMachines/', parameters('vmName'))]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "properties": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "status":"Enabled",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "timeZoneId":"W. Europe Standard Time",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "taskType":"ComputeVmShutdownTask",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "notificationSettings":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "status":"Disabled",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "timeInMinutes":15,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "webhookUrl":null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "targetResourceId":"[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "dailyRecurrence":{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          "time":"1800"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "outputs": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "PublicDNS": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type" : "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "value": "[reference(variables('publicIPAddressName')).dnsSettings.fqdn]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "HostName": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type" : "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "value": "[parameters('vmName')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "VSTSAgentName": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type" : "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "value": "[variables('agentname')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "VSTSProjectName": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type" : "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "value": "[parameters('urlvsts')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "ScritpURI": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type" : "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "value": "[variables('filescriptURI')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "AccessRDPFrom": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "type" : "string",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      "value": "[parameters('accessIPNSG')]"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h1><strong>PrzykÅ‚ad:</strong></h1><h3 class="anchor anchorWithStickyNavbar_mojV" id="aby-wykonaÄ‡-deployment-naleÅ¼y-utworzyÄ‡-resource-groupÄ™"><strong>Aby wykonaÄ‡ deployment naleÅ¼y utworzyÄ‡ Resource Group'Ä™:</strong><a class="hash-link" href="#aby-wykonaÄ‡-deployment-naleÅ¼y-utworzyÄ‡-resource-groupÄ™" title="Direct link to heading">â€‹</a></h3><p><code>New-AzureRMResourceGroup -Name VSTS -Location westeurope</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="wykonanie-deploymentu"><strong>Wykonanie deploymentâ€™u:</strong><a class="hash-link" href="#wykonanie-deploymentu" title="Direct link to heading">â€‹</a></h3><p><code>New-AzureRMResourceGroupDeployment -ResourceGroupName VSTS -TemplateURI "https://raw.githubusercontent.com/RogalaPiotr/JustCloudPublic/master/simple-vm-with-installation-vsts-agent/azuredeploy.json" -Verbose</code></p><p><strong>Efekt w portalu po deployâ€™mencie:</strong></p><p><a target="_blank" href="/assets/files/Clipboard21-8d851887072ff59a7d848fb97d94ba0e.jpg"><img src="/assets/images/Clipboard21-8d851887072ff59a7d848fb97d94ba0e.jpg" width="1360" height="637"></a></p><p><strong>Widok puli agentÃ³w w VSTS:</strong></p><p><a target="_blank" href="/assets/files/Clipboard22-1b82d9e149275cd7f3aa92dc67e94dc2.jpg"><img src="/assets/images/Clipboard22-1b82d9e149275cd7f3aa92dc67e94dc2.jpg" width="925" height="335"></a></p><p>Maszyna jest gotowa do deployâ€™mentÃ³w, jeÅ›li potrzebujesz wiÄ™cej maszyn moÅ¼esz bez oporu deployâ€™owaÄ‡ wiÄ™kszÄ… iloÅ›Ä‡ :)</p><p>Czas deplymentu to: 15 minutes 46 seconds.</p>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="arm" term="arm"/>
        <category label="automation" term="automation"/>
        <category label="azure" term="azure"/>
        <category label="deplyoment" term="deplyoment"/>
        <category label="json" term="json"/>
        <category label="microsoft" term="microsoft"/>
        <category label="vsts" term="vsts"/>
        <category label="ado" term="ado"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Google Cloud Platform deployment VM z Ubuntu]]></title>
        <id>google-cloud-platform-deployment-vm-z-ubuntu</id>
        <link href="https://blog.justcloud.pl/google-cloud-platform-deployment-vm-z-ubuntu"/>
        <updated>2017-10-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Pierwszy deployment w Google Cloud Platform nie musi byÄ‡ trudny. Zapraszam to sprawdzenia rozwiÄ…zaÅ„ dostÄ™pnyw GCP, a zaczniemy od wdroÅ¼enia wirtualnej maszyny za pomocÄ… szablonu.]]></summary>
        <content type="html"><![CDATA[<p>ZastanawialiÅ›cie siÄ™ jak dziaÅ‚ajÄ… szablony w Google Cloud Platform? MiaÅ‚em jakiÅ› czas temu moÅ¼liwoÅ›Ä‡ dowiedzieÄ‡ siÄ™ jak to dziaÅ‚a, dlatego postanowiÅ‚em zrobiÄ‡ maÅ‚y wpis na ten temat. Czym jest GCP (Google Cloud Platform)? JeÅ›li wiesz czym jest Azure i Amazon Web Services (AWS) to GCP jest kolejnym dostawcÄ… z podobnymi rozwiÄ…zaniami. Od ponad roku GCP jest prÄ™Å¼nie rozwijane w stronÄ™ rynku wirtualnych maszyn i web serwisÃ³w wychodzÄ…c na przeciw AWS'owi i Azure'owi powstaÅ‚ portal analogicznie podobny do zarzÄ…dzania wÅ‚asnymi projektami moÅ¼na to odwzorowaÄ‡ tak jakby do subskrypcji w Azure.</p><p>Portal: <a href="https://console.cloud.google.com" target="_blank" rel="noopener noreferrer">https://console.cloud.google.com</a></p><p><a target="_blank" href="/assets/files/capture_010_08102017_140927-9dda36b0a5f67893ca2a13bfbdcaba6a.jpg"><img src="/assets/images/capture_010_08102017_140927-9dda36b0a5f67893ca2a13bfbdcaba6a.jpg" width="1904" height="946"></a></p><p>Google udostÄ™pnia wÅ‚asne CLI do zarzÄ…dzania projektami:&nbsp;<a href="https://cloud.google.com/sdk/" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sdk/</a> po instalacji SDK moÅ¼emy uÅ¼ywaÄ‡ komend np. do deploymentu. Deploment wirtualnej maszyny rÃ³Å¼ni siÄ™ znaczÄ…co od tych ktÃ³rych uÅ¼ywamy w Azure i AWS, majÄ… one rozszerzenia. jinja lub. yaml gdzie moÅ¼emy wspomagaÄ‡ nasz deployment plikami python'owymi .py. Daje to nam duÅ¼e moÅ¼liwoÅ›ci konstruowania skomplikowanych delpoymentÃ³w.</p><p>Zajrzyjmy do przygotowanego przeze mnie deploymentu VM z systemem ubuntu:&nbsp;<a href="https://github.com/RogalaPiotr/JustCloudPublic/blob/master/gcloud-simple-ubuntu" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/blob/master/gcloud-simple-ubuntu</a></p><p>W poniÅ¼szym kodzie naleÅ¼y zaktualizowaÄ‡ go o wartoÅ›ci nazwy projektu podmieniajÄ…c "wartoÅ›Ä‡ your-project-name", plik vm .yaml:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- type: compute.v1.instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: simple-ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  properties:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zone: europe-west1-c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    machineType: projects/your-project-name/zones/europe-west1-c/machineTypes/f1-micro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disks:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - deviceName: boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: PERSISTENT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      boot: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      autoDelete: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initializeParams:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sourceImage: projects/your-project-name/global/images/ubuntu-1604-xenial-v20170815a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskType: projects/your-project-name/zones/europe-west1-c/diskTypes/pd-standard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    networkInterfaces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - network: projects/your-project-name/global/networks/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accessConfigs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - name: External NAT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type: ONE_TO_ONE_NAT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Na pierwszy rzut oka plik nie jest skomplikowany, poniewaÅ¼ plik .yaml jest tylko skrÃ³tem definicji ktÃ³re sÄ… wysyÅ‚ane dalej do schematu gdzie pod spodem ma duÅ¼o wiÄ™cej funkcji, ktÃ³rych nie musimy definiowaÄ‡.</p><p>Po zalogowaniu siÄ™ z cmd do GCP moÅ¼emy wywoÅ‚aÄ‡ powyÅ¼szy deployment uÅ¼ywajÄ…c polecenia:</p><p><code>gcloud deployment-manager deployments create simple-ubuntu --config vm.yaml</code></p><p>Po wykonaniu tego polecenia rozpocznie siÄ™ deployment a nastÄ™pnie zostanie uruchomiona maszyna z systemem ubuntu. Zapraszam do testowania i zadawani pytaÅ„.</p><p><a target="_blank" href="/assets/files/capture_012_08102017_145512-3b50e7a61b62877d75884b25d100dce0.jpg"><img src="/assets/images/capture_012_08102017_145512-3b50e7a61b62877d75884b25d100dce0.jpg" width="1279" height="587"></a></p><p><a target="_blank" href="/assets/files/capture_013_08102017_145520-92105ab0554ba04be699dfa98d5ccd44.jpg"><img src="/assets/images/capture_013_08102017_145520-92105ab0554ba04be699dfa98d5ccd44.jpg" width="896" height="228"></a></p><p><a target="_blank" href="/assets/files/capture_014_08102017_145606-7a18296796b1ffe41fcde1edeeeb44c3.jpg"><img src="/assets/images/capture_014_08102017_145606-7a18296796b1ffe41fcde1edeeeb44c3.jpg" width="1018" height="600"></a></p>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="gcloud" term="gcloud"/>
        <category label="gcp" term="gcp"/>
        <category label="google cloud-platform" term="google cloud-platform"/>
        <category label="ubuntu" term="ubuntu"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Delete VM and create again based on .vhd]]></title>
        <id>delete-vm-and-create-again-based-on-vhd</id>
        <link href="https://blog.justcloud.pl/delete-vm-and-create-again-based-on-vhd"/>
        <updated>2017-09-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Rekreowanie maszyny z istniejÄ…cego dysku moÅ¼e byÄ‡ konieczne kiedy mamy migracjÄ™Â lub problemy z maszynÄ…. Ten artykuÅ‚ opisuje jak sprawnie przejÅ›Ä‡ przed ten proces.]]></summary>
        <content type="html"><![CDATA[<p>W tej czÄ™Å›ci tytuÅ‚ jest angielski,&nbsp;poniewaÅ¼ nie stosuje spolszczeÅ„ dla technicznego jÄ™zyka. Ten post jest spowodowany tym co Microsoft niestety przestaÅ‚ wspieraÄ‡ w Azure a mianowicie breaklease dla blobÃ³w podpiÄ™tych do wirtualnej maszyny. ByÅ‚o mi to potrzebne do jednego zadania, dlatego byÅ‚em zmuszony zrobiÄ‡ coÅ› innego. Mianowicie potrzebne mi byÅ‚o usuniÄ™cie maszyny i stworzenie jej bazujÄ…c na istniejÄ…cych vhd'kach w innym kontenerze dodatkowo moje zaÅ‚oÅ¼enie wymagaÅ‚o powershell'a. W skrÃ³cie odtworzenie maszyny z jakiegoÅ› stanu, ktÃ³ry jest przechowywany jako kopia dyskÃ³w wirtualnej maszyny. MyÅ›lÄ™, Å¼e sÄ… osoby, ktÃ³rym siÄ™ to przyda.</p><p>KrÃ³tki opis:</p><ol><li>Podajemy nazwÄ™ maszyny lub listÄ™ maszyn z naszej subskrypcji.</li><li>Na podstawie nazwy maszyny znajdujemy resource groupe.</li><li>WyÅ‚Ä…czamy maszynÄ™.</li><li>Na podstawie RG i nazwy VM sprawdzamy jakie dyski sÄ… podpiÄ™te do maszyny.</li><li>Znajdujemy sobie context dla dyskÃ³w.</li><li>MajÄ…c wszystkie dane przechodzimy do usuwania maszyny.</li><li>Usuwany obecny vhd z OS.</li><li>Kopiujemy w jego miejsce wczeÅ›niej skopiowany vhd z kontenera "images".</li><li>Przeprowadzamy dalej tÄ… samÄ… operacje dla wszystkich podpiÄ™tych dyskÃ³w data.</li><li>Na podstawie wszystkich zebranych wczeÅ›niej danych tworzymy wirtualnÄ… maszynÄ™.</li></ol><p>Puenta jest taka. JeÅ›li okaÅ¼e siÄ™, Å¼e ktÃ³regoÅ› razu Microsoft Support powie wam, Å¼e trzeba usunÄ…Ä‡ maszynÄ™ i stworzyÄ‡ jÄ… ponownie dziÄ™ki temu skryptowi moÅ¼ecie to zrobiÄ‡ zaledwie w 5 minut i potwierdziÄ‡, czy to pomogÅ‚o czy diagnoza Supportu byÅ‚a niewÅ‚aÅ›ciwa. Zdarza siÄ™, Å¼e MS sugeruje usuniÄ™cie maszyny i stworzenie jej ponownie i majÄ…c np. 5 maszyn wiecie, Å¼e nie jest to zabawa na 5 minut. Ale teraz wykorzystujÄ…c ten skrypt moÅ¼ecie to zrobiÄ‡. WczeÅ›niejszym etapem bÄ™dzie poprawienie skryptu, aby nie usuwaÄ‡ dyskÃ³w vhd tylko uÅ¼yÄ‡ obecnych. Natomiast jeÅ›li chcecie zrobiÄ‡ sobie kopie bezpieczeÅ„stwa dyskÃ³w vhd to bÄ™dzie naleÅ¼eÄ‡ przeprowadziÄ‡ procedurÄ™ wyÅ‚Ä…czenia maszyn skopiowania vhd'kÃ³w np. do kontenera "images" i puÅ›ciÄ‡ poniÅ¼szy skrypt.</p><p>Skrpyt w bardziej czytelnej formie na github:&nbsp;<a href="https://github.com/RogalaPiotr/JustCloudPublic/tree/master/recreate-vm-from-vhd" target="_blank" rel="noopener noreferrer">https://github.com/RogalaPiotr/JustCloudPublic/tree/master/recreate-vm-from-vhd</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$vms = @("SimpleWindowsVM")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$sourcecontainerimage = "images"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function recreatevms {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach ($vm in $vms) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "VM name: "$vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmrg = Get-AzureRmResource | Where-Object {$_.Name -like $vm}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "VM Resource Group: "$vmrg.ResourceGroupName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmsize = (Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -VMName $vm).HardwareProfile.VmSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "VM size: "$vmsize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $nicvm = Get-AzureRmNetworkInterface -ResourceGroupName $vmrg.ResourceGroupName | Where-Object {$_.VirtualMachine.Id -like "*$vm*"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "VM NIC name: "$nicvm.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmstatus = Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm -Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "VM status is: "$vmstatus.Statuses.DisplayStatus[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if($vmstatus.Statuses.DisplayStatus -like "*running*"){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Write-Host "VM stopping: "$vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $tmp = Stop-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmdiskos = ((Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm).StorageProfile).OsDisk 3&gt; $null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmdisksdata = ((Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm).StorageProfile).DataDisks 3&gt; $null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "Get VM disk os: "$vmdiskos.Name </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "Get VM disk data: "$vmdisksdata.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "Get VM disk data count: "$vmdisksdata.Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storagediskosname = ($vmdiskos.Vhd.Uri.Split("/")[2]).Replace(".blob.core.windows.net","")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $containerdiskos = ($vmdiskos.Vhd.Uri.Split("/")[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmdiskosname = ($vmdiskos.Vhd.Uri.Split("/")[4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storageaccountos = Get-AzureRmResource | Where-Object {$_.Name -like "$storagediskosname"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storageaccountkeyos = (Get-AzureRmStorageAccountKey -Name $storageaccountos.Name -ResourceGroupName $storageaccountos.ResourceGroupName).Value[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $storagecontext = New-AzureStorageContext -StorageAccountName $storageaccountos.Name -StorageAccountKey $storageaccountkeyos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $container = Get-AzureStorageContainer -Name $containerdiskos -context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $containerdiskosimage = $vmdiskos.Vhd.Uri -replace("vhds",$sourcecontainerimage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Remove-AzureRmVM -Name $vm -ResourceGroupName $vmrg.ResourceGroupName -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "Removing VM: "$vm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Remove-AzureStorageBlob -Blob $vmdiskosname -Container vhds -Context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "Removing VM os disk uri: "$vmdiskos.Vhd.Uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $tmp = Start-AzureStorageBlobCopy -srcUri $containerdiskosimage -SrcContext $storagecontext -DestContainer $containerdiskos -DestBlob $vmdiskosname -DestContext $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host  "Copying new os disk uri: "$containerdiskosimage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (![string]::IsNullOrEmpty($vmdisksdata)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            foreach ($vmdiskdata in $vmdisksdata){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storagediskdataname = ($vmdiskdata.Vhd.Uri.Split("/")[2]).Replace(".blob.core.windows.net","")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $containerdiskdata = ($vmdiskdata.Vhd.Uri.Split("/")[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $vmdiskdataname = ($vmdiskdata.Vhd.Uri.Split("/")[4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storageaccountdata = Get-AzureRmResource | Where-Object {$_.Name -like "$storagediskdataname"}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storageaccountkeydata = (Get-AzureRmStorageAccountKey -Name $storageaccountdata.Name -ResourceGroupName $storageaccountdata.ResourceGroupName).Value[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $storagecontext = New-AzureStorageContext -StorageAccountName $storageaccountdata.Name -StorageAccountKey $storageaccountkeydata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $container = Get-AzureStorageContainer -Name $containerdiskdata -context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $containerdiskdataimage = $vmdiskdata.Vhd.Uri -replace("vhds",$sourcecontainerimage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Remove-AzureStorageBlob -Blob $vmdiskdataname -Container vhds -Context $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Write-Host "Removing VM data disk uri: "$vmdiskdata.Vhd.Uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $tmp = Start-AzureStorageBlobCopy -srcUri $containerdiskdataimage -SrcContext $storagecontext -DestContainer $containerdiskdata -DestBlob $vmdiskdataname -DestContext $storagecontext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Write-Host  "Copying new os disk uri: "$containerdiskdataimage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Write-Host "Creating VM"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = New-AzureRmVMConfig -VMName $vm -VMSize $vmsize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = Set-AzureRmVMOSDisk -VM $vmConfig -Name $vmdiskos.Name -VhdUri $vmdiskos.Vhd.Uri -CreateOption Attach -Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($vmdisksdata.count -ge 0){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $i = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            foreach ($vmdiskdatavm in $vmdisksdata){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $vmConfig = Add-AzureRmVMDataDisk -VM $vmConfig -VhdUri $vmdiskdatavm.Vhd.Uri -CreateOption Attach -Lun $i -Name $vmdiskdatavm.Name -Caching ReadWrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $i++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = Add-AzureRmVMNetworkInterface -VM $vmConfig -Id $nicvm.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vmConfig = Set-AzureRmVMBootDiagnostics -VM $vmConfig -Disable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $vm = New-AzureRmVM -VM $vmConfig -Location $vmrg.Location -ResourceGroupName $vmrg.ResourceGroupName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############################################################################################################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Recreate VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">############################################################################################################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recreatevms</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div>]]></content>
        <author>
            <name>Piotr Rogala</name>
            <uri>https://github.com/RogalaPiotr</uri>
        </author>
        <category label="azure" term="azure"/>
        <category label="blob" term="blob"/>
        <category label="devops" term="devops"/>
        <category label="powershell" term="powershell"/>
        <category label="storage" term="storage"/>
        <category label="vm" term="vm"/>
        <category label="migracja" term="migracja"/>
    </entry>
</feed>