"use strict";(self.webpackChunkjustcloudblog=self.webpackChunkjustcloudblog||[]).push([[280],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return p}});var o=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var m=o.createContext({}),c=function(e){var t=o.useContext(m),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=c(e.components);return o.createElement(m.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},l=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,m=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),l=c(a),p=n,g=l["".concat(m,".").concat(p)]||l[p]||d[p]||r;return a?o.createElement(g,i(i({ref:t},u),{},{components:a})):o.createElement(g,i({ref:t},u))}));function p(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,i=new Array(r);i[0]=l;var s={};for(var m in t)hasOwnProperty.call(t,m)&&(s[m]=t[m]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var c=2;c<r;c++)i[c]=a[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,a)}l.displayName="MDXCreateElement"},3102:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return s},contentTitle:function(){return m},metadata:function(){return c},assets:function(){return u},toc:function(){return d},default:function(){return p}});var o=a(7462),n=a(3366),r=(a(7294),a(3905)),i=["components"],s={slug:"delete-vm-and-create-again-based-on-vhd",title:"Delete VM and create again based on .vhd",description:"Rekreowanie maszyny z istniej\u0105cego dysku mo\u017ce by\u0107 konieczne kiedy mamy migracj\u0119\xa0lub problemy z maszyn\u0105. Ten artyku\u0142 opisuje jak sprawnie przej\u015b\u0107 przed ten proces.",date:"2017-09-30",authors:["progala"],tags:["azure","blob","devops","powershell","storage","vm","migracja"],keywords:["powershell","azure","microsoft azure","storage account","vhd","migracja","migration","network","sie\u0107","blog"],hide_table_of_contents:!0},m=void 0,c={permalink:"/delete-vm-and-create-again-based-on-vhd",source:"@site/blog/2017-09-30-delete-vm-and-create-again-based-on-vhd/index.md",title:"Delete VM and create again based on .vhd",description:"Rekreowanie maszyny z istniej\u0105cego dysku mo\u017ce by\u0107 konieczne kiedy mamy migracj\u0119\xa0lub problemy z maszyn\u0105. Ten artyku\u0142 opisuje jak sprawnie przej\u015b\u0107 przed ten proces.",date:"2017-09-30T00:00:00.000Z",formattedDate:"September 30, 2017",tags:[{label:"azure",permalink:"/tags/azure"},{label:"blob",permalink:"/tags/blob"},{label:"devops",permalink:"/tags/devops"},{label:"powershell",permalink:"/tags/powershell"},{label:"storage",permalink:"/tags/storage"},{label:"vm",permalink:"/tags/vm"},{label:"migracja",permalink:"/tags/migracja"}],readingTime:3.38,truncated:!0,authors:[{name:"Piotr Rogala",title:"MVP Azure & owner JustCloud.pl",url:"https://github.com/RogalaPiotr",imageURL:"https://avatars.githubusercontent.com/u/31566956?v=4",key:"progala"}],frontMatter:{slug:"delete-vm-and-create-again-based-on-vhd",title:"Delete VM and create again based on .vhd",description:"Rekreowanie maszyny z istniej\u0105cego dysku mo\u017ce by\u0107 konieczne kiedy mamy migracj\u0119\xa0lub problemy z maszyn\u0105. Ten artyku\u0142 opisuje jak sprawnie przej\u015b\u0107 przed ten proces.",date:"2017-09-30",authors:["progala"],tags:["azure","blob","devops","powershell","storage","vm","migracja"],keywords:["powershell","azure","microsoft azure","storage account","vhd","migracja","migration","network","sie\u0107","blog"],hide_table_of_contents:!0},prevItem:{title:"Google Cloud Platform deployment VM z Ubuntu",permalink:"/google-cloud-platform-deployment-vm-z-ubuntu"},nextItem:{title:"Deployment maszyny z funkcj\u0105 Auto-Shutdown  za pomoc\u0105 szablonu arm",permalink:"/deployment-maszyny-z-funkcja-auto-shutdown-za-pomoca-szablonu-arm"}},u={authorsImageUrls:[void 0]},d=[],l={toc:d};function p(e){var t=e.components,a=(0,n.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},l,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"W tej cz\u0119\u015bci tytu\u0142 jest angielski,\xa0poniewa\u017c nie stosuje spolszcze\u0144 dla technicznego j\u0119zyka. Ten post jest spowodowany tym co Microsoft niestety przesta\u0142 wspiera\u0107 w Azure a mianowicie breaklease dla blob\xf3w podpi\u0119tych do wirtualnej maszyny. By\u0142o mi to potrzebne do jednego zadania, dlatego by\u0142em zmuszony zrobi\u0107 co\u015b innego. Mianowicie potrzebne mi by\u0142o usuni\u0119cie maszyny i stworzenie jej bazuj\u0105c na istniej\u0105cych vhd'kach w innym kontenerze dodatkowo moje za\u0142o\u017cenie wymaga\u0142o powershell'a. W skr\xf3cie odtworzenie maszyny z jakiego\u015b stanu, kt\xf3ry jest przechowywany jako kopia dysk\xf3w wirtualnej maszyny. My\u015bl\u0119, \u017ce s\u0105 osoby, kt\xf3rym si\u0119 to przyda."),(0,r.kt)("p",null,"Kr\xf3tki opis:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Podajemy nazw\u0119 maszyny lub list\u0119 maszyn z naszej subskrypcji."),(0,r.kt)("li",{parentName:"ol"},"Na podstawie nazwy maszyny znajdujemy resource groupe."),(0,r.kt)("li",{parentName:"ol"},"Wy\u0142\u0105czamy maszyn\u0119."),(0,r.kt)("li",{parentName:"ol"},"Na podstawie RG i nazwy VM sprawdzamy jakie dyski s\u0105 podpi\u0119te do maszyny."),(0,r.kt)("li",{parentName:"ol"},"Znajdujemy sobie context dla dysk\xf3w."),(0,r.kt)("li",{parentName:"ol"},"Maj\u0105c wszystkie dane przechodzimy do usuwania maszyny."),(0,r.kt)("li",{parentName:"ol"},"Usuwany obecny vhd z OS."),(0,r.kt)("li",{parentName:"ol"},'Kopiujemy w jego miejsce wcze\u015bniej skopiowany vhd z kontenera "images".'),(0,r.kt)("li",{parentName:"ol"},"Przeprowadzamy dalej t\u0105 sam\u0105 operacje dla wszystkich podpi\u0119tych dysk\xf3w data."),(0,r.kt)("li",{parentName:"ol"},"Na podstawie wszystkich zebranych wcze\u015bniej danych tworzymy wirtualn\u0105 maszyn\u0119.")),(0,r.kt)("p",null,'Puenta jest taka. Je\u015bli oka\u017ce si\u0119, \u017ce kt\xf3rego\u015b razu Microsoft Support powie wam, \u017ce trzeba usun\u0105\u0107 maszyn\u0119 i stworzy\u0107 j\u0105 ponownie dzi\u0119ki temu skryptowi mo\u017cecie to zrobi\u0107 zaledwie w 5 minut i potwierdzi\u0107, czy to pomog\u0142o czy diagnoza Supportu by\u0142a niew\u0142a\u015bciwa. Zdarza si\u0119, \u017ce MS sugeruje usuni\u0119cie maszyny i stworzenie jej ponownie i maj\u0105c np. 5 maszyn wiecie, \u017ce nie jest to zabawa na 5 minut. Ale teraz wykorzystuj\u0105c ten skrypt mo\u017cecie to zrobi\u0107. Wcze\u015bniejszym etapem b\u0119dzie poprawienie skryptu, aby nie usuwa\u0107 dysk\xf3w vhd tylko u\u017cy\u0107 obecnych. Natomiast je\u015bli chcecie zrobi\u0107 sobie kopie bezpiecze\u0144stwa dysk\xf3w vhd to b\u0119dzie nale\u017ce\u0107 przeprowadzi\u0107 procedur\u0119 wy\u0142\u0105czenia maszyn skopiowania vhd\'k\xf3w np. do kontenera "images" i pu\u015bci\u0107 poni\u017cszy skrypt.'),(0,r.kt)("p",null,"Skrpyt w bardziej czytelnej formie na github:\xa0",(0,r.kt)("a",{parentName:"p",href:"https://github.com/RogalaPiotr/JustCloudPublic/tree/master/recreate-vm-from-vhd"},"https://github.com/RogalaPiotr/JustCloudPublic/tree/master/recreate-vm-from-vhd")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'$vms = @("SimpleWindowsVM")\n$sourcecontainerimage = "images"\nfunction recreatevms {\n    foreach ($vm in $vms) {\n        Write-Host "VM name: "$vm\n        $vmrg = Get-AzureRmResource | Where-Object {$_.Name -like $vm}\n        Write-Host "VM Resource Group: "$vmrg.ResourceGroupName\n        $vmsize = (Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -VMName $vm).HardwareProfile.VmSize\n        Write-Host "VM size: "$vmsize\n        $nicvm = Get-AzureRmNetworkInterface -ResourceGroupName $vmrg.ResourceGroupName | Where-Object {$_.VirtualMachine.Id -like "*$vm*"}\n        Write-Host "VM NIC name: "$nicvm.Name\n        $vmstatus = Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm -Status\n        Write-Host "VM status is: "$vmstatus.Statuses.DisplayStatus[1]\n        if($vmstatus.Statuses.DisplayStatus -like "*running*"){\n            Write-Host "VM stopping: "$vm\n            $tmp = Stop-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm -Force\n        }\n        $vmdiskos = ((Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm).StorageProfile).OsDisk 3> $null\n        $vmdisksdata = ((Get-AzureRmVM -ResourceGroupName $vmrg.ResourceGroupName -Name $vm).StorageProfile).DataDisks 3> $null\n        Write-Host "Get VM disk os: "$vmdiskos.Name \n        Write-Host "Get VM disk data: "$vmdisksdata.Name\n        Write-Host "Get VM disk data count: "$vmdisksdata.Count\n\n        $storagediskosname = ($vmdiskos.Vhd.Uri.Split("/")[2]).Replace(".blob.core.windows.net","")\n        $containerdiskos = ($vmdiskos.Vhd.Uri.Split("/")[3])\n        $vmdiskosname = ($vmdiskos.Vhd.Uri.Split("/")[4])\n        $storageaccountos = Get-AzureRmResource | Where-Object {$_.Name -like "$storagediskosname"}\n        $storageaccountkeyos = (Get-AzureRmStorageAccountKey -Name $storageaccountos.Name -ResourceGroupName $storageaccountos.ResourceGroupName).Value[0]\n        $storagecontext = New-AzureStorageContext -StorageAccountName $storageaccountos.Name -StorageAccountKey $storageaccountkeyos\n        $container = Get-AzureStorageContainer -Name $containerdiskos -context $storagecontext\n\n        $containerdiskosimage = $vmdiskos.Vhd.Uri -replace("vhds",$sourcecontainerimage)\n        \n        Remove-AzureRmVM -Name $vm -ResourceGroupName $vmrg.ResourceGroupName -Force\n        Write-Host "Removing VM: "$vm\n        Remove-AzureStorageBlob -Blob $vmdiskosname -Container vhds -Context $storagecontext\n        Write-Host "Removing VM os disk uri: "$vmdiskos.Vhd.Uri\n        $tmp = Start-AzureStorageBlobCopy -srcUri $containerdiskosimage -SrcContext $storagecontext -DestContainer $containerdiskos -DestBlob $vmdiskosname -DestContext $storagecontext\n        Write-Host  "Copying new os disk uri: "$containerdiskosimage\n\n        if (![string]::IsNullOrEmpty($vmdisksdata)){\n            foreach ($vmdiskdata in $vmdisksdata){\n\n                $storagediskdataname = ($vmdiskdata.Vhd.Uri.Split("/")[2]).Replace(".blob.core.windows.net","")\n                $containerdiskdata = ($vmdiskdata.Vhd.Uri.Split("/")[3])\n                $vmdiskdataname = ($vmdiskdata.Vhd.Uri.Split("/")[4])\n                $storageaccountdata = Get-AzureRmResource | Where-Object {$_.Name -like "$storagediskdataname"}\n                $storageaccountkeydata = (Get-AzureRmStorageAccountKey -Name $storageaccountdata.Name -ResourceGroupName $storageaccountdata.ResourceGroupName).Value[0]\n                $storagecontext = New-AzureStorageContext -StorageAccountName $storageaccountdata.Name -StorageAccountKey $storageaccountkeydata\n                $container = Get-AzureStorageContainer -Name $containerdiskdata -context $storagecontext\n                \n                $containerdiskdataimage = $vmdiskdata.Vhd.Uri -replace("vhds",$sourcecontainerimage)\n                        \n                Remove-AzureStorageBlob -Blob $vmdiskdataname -Container vhds -Context $storagecontext\n                Write-Host "Removing VM data disk uri: "$vmdiskdata.Vhd.Uri\n                $tmp = Start-AzureStorageBlobCopy -srcUri $containerdiskdataimage -SrcContext $storagecontext -DestContainer $containerdiskdata -DestBlob $vmdiskdataname -DestContext $storagecontext\n                Write-Host  "Copying new os disk uri: "$containerdiskdataimage\n            }  \n        }\n        Write-Host "Creating VM"\n        $vmConfig = New-AzureRmVMConfig -VMName $vm -VMSize $vmsize\n        $vmConfig = Set-AzureRmVMOSDisk -VM $vmConfig -Name $vmdiskos.Name -VhdUri $vmdiskos.Vhd.Uri -CreateOption Attach -Windows\n        if ($vmdisksdata.count -ge 0){\n            $i = 0\n            foreach ($vmdiskdatavm in $vmdisksdata){\n                $vmConfig = Add-AzureRmVMDataDisk -VM $vmConfig -VhdUri $vmdiskdatavm.Vhd.Uri -CreateOption Attach -Lun $i -Name $vmdiskdatavm.Name -Caching ReadWrite\n                $i++\n            }\n        }\n        $vmConfig = Add-AzureRmVMNetworkInterface -VM $vmConfig -Id $nicvm.Id\n        $vmConfig = Set-AzureRmVMBootDiagnostics -VM $vmConfig -Disable\n        $vm = New-AzureRmVM -VM $vmConfig -Location $vmrg.Location -ResourceGroupName $vmrg.ResourceGroupName\n    }   \n}\n############################################################################################################\n# Recreate VM\n############################################################################################################\n\nrecreatevms\n')))}p.isMDXComponent=!0}}]);